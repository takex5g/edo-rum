# 江戸走り検出アルゴリズム

## 概要

本システムは、MediaPipe Pose Landmarkerを使用してリアルタイムに人体の姿勢を検出し、「江戸走り」の特徴的なフォームを判定します。

## 江戸走りとは

江戸走りは、日本の伝統的な走り方で、現代のランニングフォームとは異なる特徴を持ちます：

- **腕の動き**: 左右の腕が内旋・外旋方向に対向する
- **足の動き**: 左右の足が内旋・外旋方向に対向する
- **膝の状態**: 膝を曲げた状態で走る

## 検出条件

江戸走りと判定されるには、以下の **3つの条件すべて** を満たす必要があります。

### 条件1: 腕が対向している (armsOpposed)

肩-肘-手首の3点で作る角度の「曲がり方向」を2D外積で判定します。

```
// 肩→肘→手首ベクトルの外積
leftArmCross = crossProduct2D(shoulder, elbow, wrist)

左腕: 外積 > 0 なら外旋、外積 < 0 なら内旋
右腕: 外積 < 0 なら外旋、外積 > 0 なら内旋

armsOpposed = 左腕が外旋 かつ 右腕が内旋
```

### 条件2: 足が対向している (feetOpposed)

膝-足首-足指の3点で作る角度の「曲がり方向」を2D外積で判定します。

```
// 膝→足首→足指ベクトルの外積
leftFootCross = crossProduct2D(knee, ankle, footIndex)

左足: 外積 > 0 なら外旋、外積 < 0 なら内旋
右足: 外積 < 0 なら外旋、外積 > 0 なら内旋

feetOpposed = 左足が外旋 かつ 右足が内旋
```

### 条件3: 膝が曲がっている (kneesBent)

両膝の角度を計算し、閾値未満であるか判定します。

```
leftKneeAngle = angle(leftHip, leftKnee, leftAnkle)
rightKneeAngle = angle(rightHip, rightKnee, rightAnkle)
kneesBent = leftKneeAngle < KNEE_ANGLE_MAX && rightKneeAngle < KNEE_ANGLE_MAX
```

## パラメータ一覧

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `CROSS_THRESHOLD` | 0.001 | 外積の閾値（腕・足の回転判定） |
| `KNEE_ANGLE_MAX` | 165° | 膝が曲がったと判定する最大角度 |
| `MIN_VISIBILITY` | 0.5 | ランドマークの最小可視性（0.0-1.0） |
| `HOLD_MS` | 1000ms | ポーズ保持時間（検出確定に必要な時間） |

## 2D外積アルゴリズム

3点 (A, B, C) から、A→B→C の曲がり方向を判定します。

```typescript
// 2Dベクトルの外積（z成分のみ）
function crossProduct2D(a: Landmark, b: Landmark, c: Landmark): number {
  const ab = { x: b.x - a.x, y: b.y - a.y };
  const bc = { x: c.x - b.x, y: c.y - b.y };
  return ab.x * bc.y - ab.y * bc.x;
}

// 戻り値:
//   正の値: 左回り（反時計回り）
//   負の値: 右回り（時計回り）
//   0: 直線状
```

## 角度計算アルゴリズム

3点 (A, B, C) から角度 ∠ABC を計算します。

```typescript
function angle(a: Landmark, b: Landmark, c: Landmark): number {
  const ab = { x: a.x - b.x, y: a.y - b.y };
  const cb = { x: c.x - b.x, y: c.y - b.y };

  const dot = ab.x * cb.x + ab.y * cb.y;
  const magAB = Math.hypot(ab.x, ab.y);
  const magCB = Math.hypot(cb.x, cb.y);

  const cosAngle = dot / (magAB * magCB);
  return Math.acos(cosAngle) * (180 / Math.PI);
}
```

## 使用するランドマーク

MediaPipe Pose Landmarkerから取得する33個のランドマークのうち、以下を使用します：

| 部位 | 左側インデックス | 右側インデックス |
|-----|----------------|-----------------|
| 肩 | 11 | 12 |
| 肘 | 13 | 14 |
| 手首 | 15 | 16 |
| 腰 | 23 | 24 |
| 膝 | 25 | 26 |
| 足首 | 27 | 28 |
| 足指 | 31 | 32 |

## 検出フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    カメラ映像/静止画像                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              MediaPipe Pose Landmarker                      │
│              (pose_landmarker_lite.task)                    │
│              33個のランドマークを検出                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    evaluatePose()                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. ランドマーク可視性チェック (visibility > 0.5)     │   │
│  │ 2. 腕の対向判定 (Z軸差分 > 0.02)                     │   │
│  │ 3. 足の対向判定 (Z軸差分 > 0.02)                     │   │
│  │ 4. 膝の屈曲判定 (角度 < 165°)                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    usePoseState                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ match = true の場合:                                 │   │
│  │   └─ 1000ms 保持 → status = 'detected'              │   │
│  │ match = false の場合:                                │   │
│  │   └─ status = 'not-detected'                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      結果表示                               │
│  - 膝角度: 円弧グラフ表示                                    │
│  - 腕/足の状態: 内旋/外旋/中立ラベル                          │
│  - OK条件: 緑色 / NG条件: 赤色                               │
└─────────────────────────────────────────────────────────────┘
```

## ファイル構成

| ファイル | 役割 |
|---------|------|
| `src/utils/pose.ts` | 検出アルゴリズム本体 (`evaluatePose()`, `angle()`) |
| `src/constants/pose.ts` | パラメータ定義 |
| `src/hooks/usePoseState.ts` | 状態管理・保持時間カウント |
| `src/utils/drawing.ts` | 検出結果の視覚化 |

## 判定結果の視覚化

検出結果は画面上に以下のように表示されます：

- **膝の角度**: 円弧グラフで現在の角度を表示（165°が閾値）
- **腕の回転状態**: 「内旋」「外旋」「中立」のラベル
- **足の回転状態**: 「内旋」「外旋」「中立」のラベル
- **色分け**: OK条件は緑色、NG条件は赤色
